
### Ý tưởng chính

Sử dụng đường dẫn file để có thể truy cập trái phép bên trong hệ thống

### Challange write-up

#### Level 1

Link challege : [Free Icon](http://pathtraversal.cyberjutsu-lab.tech:8091/)
Đề bài yêu cầu đọc nội dung của file /etc/passwd trong hệ thống

``` php
// File loadimage.php
<?php

$file_name = $_GET['file_name'];

$file_path = '/var/www/html/images/' . $file_name;

if (file_exists($file_path)) {

    header('Content-Type: image/png');

    readfile($file_path);

}

else { // Image file not found

    echo " 404 Not Found";

}
```


+ Ở đây, lập trình viên đã sử dụng untrusted data là biến `$_GET['file_name']` để nối vào `$file_path` sau đó sử dụng biến này để trỏ tới đường dẫn của tệp muốn đọc và đọc tệp đó
+ Ta có thể thao túng `$file_path` bằng `$file_name`
+ Cụ thể, ở bài này ta sẽ nối vào chuỗi file_path 1 chuỗi liên tục các dấu `..` để quay về thư mục gốc rồi nối thêm đường dẫn `/etc/password` để trỏ tới file password. Sử dụng BurpSuite hoặc nhập trực tiếp trên thanh tìm kiếm gán tham số file_name khi gửi GET method.
+ Trong ngữ cảnh ta không biết mình đang nằm ở đường dẫn nào và cần bao nhiêu dấu `..` để quay về thư mục root thì ta có thể spam `..` nhiều lần để chắc chắn vì khi ở thư mục root rồi, bạn `..` thì đường dẫn vẫn sẽ không thay đổi.

```php
$file_name = ../../../../etc/passwd
$file_path = /var/www/html/images/../../../../etc/passwd = /etc/passwd
```


#### Level 2

Link challenge: http://pathtraversal.cyberjutsu-lab.tech:8092/
Đề bài yêu cầu đọc nội dung của file /etc/passwd trong hệ thống

```php
// file loadimage.php
<?php

$file = $_GET['file'];

if (strpos($file, "..") !== false)

    die("Hack detected");

if (file_exists($file)) {

    header('Content-Type: image/png');

    readfile($file);

}

else { // Image file not found

    echo " 404 Not Found";

}?>
```


+ Lập trình viên đã kiểm soát biến `$file` không được phép có kí tự `..` ở bên trong nên chúng ta không thể sử dụng cách sử dụng các dấu `..`
+ Nhưng ở đây khác với challage 1 là lập trình viên đã truyền thẳng biến `$file` vào hàm readfile mà không nối nó với 1 tiền tố là đường dẫn nào => Ta có thể kiểm soát toàn bộ đường dẫn bằng cách sử dụng absolute path.
+ Ta chỉ cần gán cho biến `$file = /etc/passwd` và lụm flag ;vv

#### Level 3

Link challege : http://pathtraversal.cyberjutsu-lab.tech:8093/
Mục tiêu: Chiếm quyền điều khiển server và đọc một tập tin bí mật ở thư mục gốc (đường dẫn `/`) để chứng minh bạn đã khai thác thành công

```php
<?php
// file index.php
// Create store place for each user (we place this in /var/www/html/upload for easily handle)

    session_start();

    if (!isset($_SESSION['dir'])) {
        $_SESSION['dir'] = '/var/www/html/upload/' . bin2hex(random_bytes(16));

    }

    $dir = $_SESSION['dir'];

    if ( !file_exists($dir) )

        mkdir($dir);

    if(isset($_FILES["files"]) && $_POST['album'] !="" ) {

        try {
            //Create Album
            $album = $dir . "/" . strtolower($_POST['album']);

            if ( !file_exists($album))
                mkdir($album);
                
            //Count Files
            $files = $_FILES['files'];
            $count = count($files["name"]);

            // Save files to user's directory
            for ($i = 0; $i < $count; $i++) {
                $newFile = $album . "/" . $files["name"][$i];
                move_uploaded_file($files["tmp_name"][$i], $newFile);

            }

       } catch(Exception $e) {
            $error = $e->getMessage();
         }

    }

?>

// Code giao diện
```

![[Pasted image 20250505220937.png]]

+ Điều đầu tiên tôi nghĩ tới sẽ là thử upload 1 file `.php` hoặc `.htaccess` để nhúng code php vào máy chủ để RCE. Nhưng điều này không khả thi ngay vì server đã config không được biên dịch bất kì file nào trong đường dẫn `/var/www/html/upload` 
![[Pasted image 20250506012900.png]]

+ => Chúng ta sẽ cố gắng upload 1 file khai thác ở ngoài tệp upload =>  Cố gắng up file trong document root.
+ Đọc file code `index.php` , ta thấy rằng biến `$album` là untrusted data và đã tác động vào file path `$newfile` => có thể tận dụng điều này để kiểm soát đường dẫn upload file.
+ Kết hợp 2 điều này lại, chúng ta sẽ up 1 file exploit kèm theo việc truyền vào biến album điều hướng đường dẫn đến document root
![[Pasted image 20250506013615.png]]
+ Sau khi rce được server. Ta sử dụng lệnh `ls /` để xem tất cả các file từ thư mục root
![[Pasted image 20250506013732.png]]
+ Cuối cùng chỉ cần cat ra file secret là lụm :)))

